'use strict';exports.__esModule=true;var _regenerator=require('D:\\Project\\rumba\\node_modules\\babel-runtime/regenerator');var _regenerator2=_interopRequireDefault(_regenerator);var _superagent=require('superagent');var _superagent2=_interopRequireDefault(_superagent);var _entify=require('./entify');var _entify2=_interopRequireDefault(_entify);function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj};}function _asyncToGenerator(fn){return function(){var gen=fn.apply(this,arguments);return new Promise(function(resolve,reject){function step(key,arg){try{var info=gen[key](arg);var value=info.value;}catch(error){reject(error);return;}if(info.done){resolve(value);}else{return Promise.resolve(value).then(function(value){step("next",value);},function(err){step("throw",err);});}}return step("next");});};}var prepareOptions=function prepareOptions(_ref){var req=_ref.req,options=_ref.options;if(options.headers){req.set(options.headers);}if(options.field){req.field(options.field);}if(options.query){req.query(options.query);}if(options.body){req.send(options.body);}if(options.withCredentials){req.withCredentials();}if(options.token){req.set({Authorization:'Bearer '+options.token});}if(options.locale){req.set({'Accept-Language':options.locale});}if(options.auth){req.auth.apply(req,options.auth);}};var checkResponce=function checkResponce(_ref2){var res=_ref2.res,options=_ref2.options;var debug=options.method.toUpperCase()+' '+options.endpoint;if(!res){throw new Error('Connection failed: '+debug);}if(!res.noContent&&res.type!=='application/json'){throw new Error('Unknown response type: \''+res.type+'\' from '+debug);}};var sendRequest=function(){var _ref3=_asyncToGenerator(_regenerator2.default.mark(function _callee(_ref4){var options=_ref4.options,dispatch=_ref4.dispatch;var req,res;return _regenerator2.default.wrap(function _callee$(_context){while(1){switch(_context.prev=_context.next){case 0:dispatch({type:'rumba.request',payload:options});req=_superagent2.default[options.method.toLowerCase()](options.endpoint);_context.prev=2;prepareOptions({req:req,options:options});_context.next=6;return req;case 6:res=_context.sent;dispatch({type:'rumba.success',meta:options,payload:{raw:res.body,normalized:options.model&&(0,_entify2.default)(res.body,options)}});checkResponce({res:res,options:options});return _context.abrupt('return',res);case 12:_context.prev=12;_context.t0=_context['catch'](2);dispatch({type:'rumba.failure',meta:options,payload:_context.t0});throw _context.t0;case 16:case'end':return _context.stop();}}},_callee,undefined,[[2,12]]);}));return function sendRequest(_x){return _ref3.apply(this,arguments);};}();exports.default=sendRequest;module.exports=exports['default'];